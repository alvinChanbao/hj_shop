<include file="public/head"/>
    <title>添加商品-火箭商城管理系统</title>
    <style>
        body{
            background: #fff;
        }
        .wrap_img {
            width: 150px;
        }

        .wrap_img img {
            width: 100%;
        }

        .sku_item{
            background: #eee;margin: 10px;
        }

        .bg_white{
            background: #fff;
        }

        .sku_item .left_name{
            display: inline-block;
        }

        .sku_item .right_box{
            width: calc(100% - 100px);
            display: inline-block;
        }
        .sku_item .right_box input{
            width: 180px;
            max-width: 90%;
            display: inline-block;
        }

        .sku_item .right_box .layui-col-xs3{
            margin-top: 10px;
        }

        .sku_item .right_box .layui-col-xs3:nth-child(-n+4){
            margin-top: 0px;
        }

        .closeBtn{
            position: absolute;
            right: 15px;
            display: inline-block;
            width: 25px;
            height: 25px;
            background: #ddd;
            border-radius: 50%;
            line-height: 25px;
            text-align: center;
            color: #fff;
            top: 16px;
            cursor: pointer;
        }

        .addSkuBtn{
            height: 38px;
            line-height: 38px;
            color: #009688;
        }

        .skuCloseBtn{
            position: absolute;
            top: -7px;
            left: 80%;
            width: 20px;
            height: 20px;
            background: #ddd;
            line-height: 20px;
            text-align: center;
            color: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .skuCloseBtn i{
            font-size: 12px;
        }

        .layui-table input{
            height: 30px;
        }

    </style>
    </head>
    <body>
    <div id="app" class="layui-fluid">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md10">
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <label for="goods_name" class="layui-form-label"><span class="x-red">*</span>商品名称</label>
                        <div class="layui-input-block">
                            <input type="text" id="goods_name" name="goods_name" required lay-verify="required"
                                   placeholder="请输入标题" autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label for="goods_name" class="layui-form-label"><span class="x-red">*</span>分类名称</label>
                        <div class="layui-input-block">
                            <input @click='getCategoryId' readonly style="width: 200px;" type="text" id="goods_category" name="goods_category" required lay-verify="required"
                                   placeholder="请选择商品类目" autocomplete="off" class="layui-input">
                            <input id="category_id" type="hidden" name="category_id" value="">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">缩略图</label>
                        <div class="layui-input-block">
                            <div onclick="uploadPic('#thumbnail')" class="wrap_img">
                                <img id="thumbnail_prev" src="__TMPL__/assets/images/default-thumbnail.png" alt="">
                            </div>
                            <input type="hidden" id="thumbnail" name="thumbnail" required lay-verify="required"
                                   placeholder="请选择缩略图" autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">商品规格</label>
                        <div style="background: #fff;border: 1px #eee solid" class="layui-input-block">
                            <div class="sku_item">

                                <template v-for="(item,index)  in addSkuData">

                                    <div class="item_list">
                                        <div style="padding: 10px;position: relative">
                                            <div class="left_name">
                                                <label >规格名：</label>
                                            </div>
                                            <div class="right_box">
                                                <input style="width: 200px;display: inline-block" type="text" value="item.sku_name" placeholder="请输入规格名" v-model="item.sku_name" autocomplete="off" class="layui-input">
                                                <div @click="deleteAddSkuItem(index)" class="closeBtn"><i class="icon iconfont">&#xe69a;</i></div>
                                            </div>
                                        </div>
                                        <div class="bg_white" style="padding: 10px" v-if="item.sku_name != ''">
                                            <div style="position: relative;bottom: 15px;" class="left_name">
                                                <label>规格值：</label>
                                            </div>
                                            <div class="right_box">
                                                <div class="layui-row">
                                                    <template v-for="(itemAttr,i) in item.sku_attr">
                                                        <div class="layui-col-xs3">
                                                            <div style="position: relative">
                                                            <input style="" type="text" placeholder="请输入规格名" autocomplete="off" class="layui-input" value="itemAttr.value" v-model="itemAttr.value">
                                                            <div @click="deleteSkuItem(index,i)" class="skuCloseBtn"><i class="icon iconfont">&#xe69a;</i></div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <div class="layui-col-xs3">
                                                        <a @click="addSkuAttrItem(index)" class="addSkuBtn" href="javascript:;">添加规格值</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </template>

                                <div style="padding: 10px;margin-top: 0;" class="sku_item">
                                    <button type="button" @click="addSkuItem" class="layui-btn"  :disabled="hasMaxSku ? 'disabled':false " :class="hasMaxSku ? 'layui-btn-disabled':''">添加规格</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">规格明细</label>
                        <div class="layui-input-block">
                            <table class="layui-table">
                                <colgroup>

                                </colgroup>
                                <thead>
                                <tr>
                                    <th>颜色</th>
                                    <th>内存</th>
                                    <th>价格（元）</th>
                                    <th>库存</th>
                                    <th>规格编码</th>
                                    <th>成本价</th>
                                    <th>销量</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>红色</td>
                                    <td>32G</td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td>0</td>
                                </tr>
                                <tr>
                                    <td>红色</td>
                                    <td>64G</td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td><input type="text" name="title" required  lay-verify="required" placeholder="" autocomplete="off" class="layui-input"></td>
                                    <td>0</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">商品详情</label>
                        <div class="layui-input-block">
                            <textarea id="details" style="display: none;"></textarea>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">推荐设置</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="like[write]" title="置顶">
                            <input type="checkbox" name="like[read]" title="推荐">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">状态</label>
                        <div class="layui-input-block">
                            <input type="radio" name="sex" value="0" title="上架" checked>
                            <input type="radio" name="sex" value="1" title="下架">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </body>
    <include file="public/scripts"/>
    <script>
        
        var app;
        var data = [];
        $(function () {
            app = new Vue({
                el:'#app',
                data:{
                    addSkuData:[
                        /*{
                            sku_name:'颜色',
                            sku_attr:[
                                {
                                    value:'红色'
                                },
                                {
                                    value:'蓝色'
                                }
                            ]
                        },
                        {
                            sku_name:'内存',
                            sku_attr:[
                                {
                                    value:'32G'
                                },
                                {
                                    value:'64G'
                                }
                            ]
                        }*/
                    ],
                    tableData:[],
                    hasMaxSku:false
                },
                watch:{
                    addSkuData:{
                        handler(val,old){
                            var that = this;
                            if (val.length >= 3){
                                that.hasMaxSku = true;
                            }
                            else{
                                that.hasMaxSku = false;
                            }

                            that.getTableSkuData(val);
                        },
                        deep:true
                    }
                },
                mounted(){
                    this.init();
                },
                methods:{
                    init:function(){
                        var that = this;
                        layui.use(['form', 'layer', 'jquery', 'layedit'],function () {
                            $ = layui.jquery;
                            var form = layui.form,
                                layer = layui.layer;
                            var layedit = layui.layedit;
                            layedit.build('details', {
                                height: 150
                            }); //建立编辑器
                            //自定义验证规则
                            form.verify({
                                nikename: function (value) {
                                    if (value.length < 5) {
                                        return '昵称至少得5个字符啊';
                                    }
                                },
                                pass: [/(.+){6,12}$/, '密码必须6到12位'],
                                repass: function (value) {
                                    if ($('#L_pass').val() != $('#L_repass').val()) {
                                        return '两次密码不一致';
                                    }
                                }
                            });

                            //监听提交
                            form.on('submit(add)',function (data) {
                                console.log(data);
                                //发异步，把数据提交给php
                                layer.alert("增加成功", {
                                        icon: 6
                                    },
                                    function () {
                                        //关闭当前frame
                                        xadmin.close();
                                        // 可以对父窗口进行刷新
                                        xadmin.father_reload();
                                    });
                                return false;
                            });
                        });

                        that.addSkuData = [
                            {
                                sku_name:'颜色',
                                sku_attr:[
                                    {
                                        value:'红色'
                                    },
                                    {
                                        value:'蓝色'
                                    },
                                    {
                                        value:'黄色'
                                    }
                                ]
                            },
                            {
                                sku_name:'内存',
                                sku_attr:[
                                    {
                                        value:'32G'
                                    },
                                    {
                                        value:'64G'
                                    }
                                ]
                            },
                            {
                                sku_name:'版本',
                                sku_attr:[
                                    {
                                        value:'全网'
                                    },
                                    {
                                        value:'移动'
                                    }
                                ]
                            }
                        ];
                    },
                    getCategoryId:function () {
                        var url = "{:url('admin/goods_category/category_api')}";
                        console.log(window.parent.document);
                        var parent = window.parent;
                        parent.layer.open({
                            type: 2,
                            area: ['95%','90%'],
                            title:'选择类目',
                            content: url, //这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
                            btn:['确认','取消'],
                            fixed:true,
                            resize:false,
                            move:false,
                            yes: function(index, layero){
                                //do something
                                console.log(window.parent.document);
                                //var body = window.parent.layer.getChildFrame('body', index);
                                iframeWin = window.parent.window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                                var category = iframeWin.getCheckValue();
                                console.log(category);
                                var category_ids = category['category_ids'] ;
                                var category_names = category['category_names'] ;
                                $("#goods_category").val(category_names);
                                $("#category_id").val(category_ids);
                                parent.layer.close(index); //如果设定了yes回调，需进行手工关闭
                            }
                        });
                    },
                    //动态添加规格
                    addSkuItem:function () {
                       var that = this;
                       var data = {
                           sku_name:'',
                           sku_attr:[
                               {
                                   value:''
                               }
                           ]
                       }
                        that.addSkuData.push(data);
                    },
                    //删除当前一项规格
                    deleteAddSkuItem:function (index) {
                        console.log(index);
                        var that = this;
                        that.addSkuData.splice(index,1);
                    },
                    //添加attr一项规格
                    addSkuAttrItem:function (index) {
                        var that = this;
                        var arr = [{
                            value:''
                        }];
                        that.addSkuData[index]['sku_attr'].push(arr);
                    },
                    //删除点中的attr
                    deleteSkuItem:function (index,i) {
                        var that = this;
                        that.addSkuData[index]['sku_attr'].splice(i,1);
                    },
                    //将添加数据转换为表格数组
                    getTableSkuData:function (val) {
                        var that = this;
                        that.getSkuNextItem(val,0);
                    },
                    //递归获取子项内容
                    getSkuNextItem:function (val,index) {

                        var that = this;
                        var length = val[index]['sku_attr'].length;
                        index++;
                        for (var i = 0; i < length; i++) {
                            if (index < val.length){
                                //console.log(index);
                                that.getSkuNextItem(val,index);
                            }
                            else{
                                console.log(index);
                            }
                        }
                    }
                    /*getSkuNextItem:function (val,index) {
                        var that = this;
                        //第1次循环
                        if (index == 0){
                            for (var i = 0; i < val[index]['sku_attr'].length; i++) {
                                // console.log(val[index]['sku_attr'][i].value);

                                //第二次循环
                                for (var j = 0; j < val[Number(index)+1]['sku_attr'].length; j++){
                                    //console.log(val[Number(index)+1]['sku_attr'][j].value);

                                    //第三次循环
                                    for (var k = 0; k < val[Number(index)+2]['sku_attr'].length; k++){
                                        console.log([val[index]['sku_attr'][i].value,val[Number(index)+1]['sku_attr'][j].value,val[Number(index)+2]['sku_attr'][k].value]);
                                        data.push([val[index]['sku_attr'][i].value,val[Number(index)+1]['sku_attr'][j].value,val[Number(index)+2]['sku_attr'][k].value]);
                                    }
                                }
                            }
                        }
                    }*/
                }
            });
        })

    </script>
    </html>